- name: Attempt to connect via SSH
  wait_for:
    host: "{{item}}"
    port: 22
    timeout: 10
  ignore_errors: yes
  register: ssh
  loop: "{{server}}"

- name: Attempt to connect via WinRM
  wait_for:
    host: "{{item}}"
    port: 5985
    timeout: 10
  ignore_errors: yes
  register: winrm
  loop: "{{server}}"

- name: Populate Linux hosts group
  add_host:
    name: "{{item.item}}"
    groups: Linux
  when: item.state is defined
  loop: "{{ssh.results}}"

- name: Populate Windows hosts group
  add_host:
    name: "{{item.item}}"
    groups: Windows
  when: item.state is defined
  loop: "{{winrm.results}}"